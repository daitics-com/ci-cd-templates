# templates/jobs/quality-gate.yml
# SonarQube Quality Gate validation
#
# Fails the pipeline if quality gate status is not OK
#
# Usage:
#   quality-gate:
#     extends: .quality-gate
#     needs: [sonarqube-scan]

.quality-gate:
  stage: code-quality
  image: alpine:latest
  variables:
    # Wait time for SonarQube to process analysis (seconds)
    QUALITY_GATE_WAIT: "15"
  before_script:
    - apk add --no-cache curl jq

    # Authenticate with Vault
    - |
      VAULT_TOKEN=$(curl -sk --request POST \
        --data "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}" \
        ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')

      if [ "$VAULT_TOKEN" = "null" ] || [ -z "$VAULT_TOKEN" ]; then
        echo "ERROR: Failed to authenticate with Vault"
        exit 1
      fi

    # Fetch SonarQube token
    - |
      SONAR_TOKEN=$(curl -sk --header "X-Vault-Token: ${VAULT_TOKEN}" \
        ${VAULT_ADDR}/v1/secret/data/cicd/sonarqube | jq -r '.data.data.ci_token')

      if [ "$SONAR_TOKEN" = "null" ] || [ -z "$SONAR_TOKEN" ]; then
        echo "ERROR: SonarQube token not found in Vault"
        exit 1
      fi

      export SONAR_TOKEN
      echo "SonarQube token retrieved"

  script:
    - echo "Checking SonarQube Quality Gate..."
    - echo "Waiting ${QUALITY_GATE_WAIT}s for analysis to complete..."
    - sleep ${QUALITY_GATE_WAIT}

    # Get Quality Gate status
    - |
      RESPONSE=$(curl -sk -u "${SONAR_TOKEN}:" \
        "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${CI_PROJECT_PATH_SLUG}")

      STATUS=$(echo "$RESPONSE" | jq -r '.projectStatus.status')

      echo "Quality Gate Status: ${STATUS}"

      if [ "$STATUS" = "OK" ]; then
        echo "Quality Gate PASSED!"
        exit 0
      elif [ "$STATUS" = "WARN" ]; then
        echo "Quality Gate WARNING - Pipeline will continue"
        exit 0
      elif [ "$STATUS" = "ERROR" ]; then
        echo "Quality Gate FAILED!"
        echo ""
        echo "Issues found:"
        echo "$RESPONSE" | jq -r '.projectStatus.conditions[] | select(.status != "OK") | "  - \(.metricKey): \(.actualValue) (threshold: \(.errorThreshold))"'
        echo ""
        echo "Fix issues at: ${SONAR_HOST_URL}/dashboard?id=${CI_PROJECT_PATH_SLUG}"
        exit 1
      else
        echo "WARNING: Could not determine Quality Gate status"
        echo "Response: $RESPONSE"
        # Don't fail pipeline if status is unknown
        exit 0
      fi

  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'