# templates/pipelines/java-springboot.yml
# Complete CI/CD pipeline for Java/Spring Boot applications
#
# Features:
#   - Maven build with caching
#   - Unit and integration tests
#   - SonarQube code quality analysis
#   - Quality gate validation
#   - Docker image build with Kaniko
#   - GitOps deployment via ArgoCD
#
# Usage in your project's .gitlab-ci.yml:
#   include:
#     - project: 'daitics-com/ci-cd-templates'
#       file: '/templates/pipelines/java-springboot.yml'
#
#   variables:
#     APP_NAME: my-java-app
#     JAVA_VERSION: "21"

include:
  - local: '/templates/base/stages.yml'

# Global variables
variables:
  JAVA_VERSION: "21"
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  REGISTRY_HOST: "gitlab:5050"

# Cache Maven dependencies
cache:
  key: "${CI_COMMIT_REF_SLUG}-maven"
  paths:
    - .m2/repository/
    - target/

# =============================================================================
# BUILD STAGE
# =============================================================================

build:
  stage: build
  image: maven:3.9-eclipse-temurin-${JAVA_VERSION}
  script:
    - echo "Building Spring Boot application..."
    - mvn ${MAVEN_CLI_OPTS} clean compile
    - echo "Build completed successfully"
  artifacts:
    paths:
      - target/classes/
    expire_in: 1 day

# =============================================================================
# TEST STAGE
# =============================================================================

test:unit:
  stage: test
  image: maven:3.9-eclipse-temurin-${JAVA_VERSION}
  script:
    - echo "Running unit tests..."
    - mvn ${MAVEN_CLI_OPTS} test
    - echo "Unit tests completed"
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/cobertura/coverage.xml
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    expire_in: 30 days

test:integration:
  stage: test
  image: maven:3.9-eclipse-temurin-${JAVA_VERSION}
  script:
    - echo "Running integration tests..."
    - mvn ${MAVEN_CLI_OPTS} verify -DskipUnitTests
    - echo "Integration tests completed"
  artifacts:
    when: always
    reports:
      junit:
        - target/failsafe-reports/TEST-*.xml
    paths:
      - target/failsafe-reports/
    expire_in: 30 days
  allow_failure: true

# =============================================================================
# CODE QUALITY STAGE
# =============================================================================

sonarqube-scan:
  stage: code-quality
  image: maven:3.9-eclipse-temurin-${JAVA_VERSION}
  variables:
    GIT_DEPTH: "0"
  before_script:
    - apt-get update && apt-get install -y curl jq

    # Authenticate with Vault
    - |
      VAULT_TOKEN=$(curl -sk --request POST \
        --data "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}" \
        ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')

    - |
      SONAR_TOKEN=$(curl -sk --header "X-Vault-Token: ${VAULT_TOKEN}" \
        ${VAULT_ADDR}/v1/secret/data/cicd/sonarqube | jq -r '.data.data.ci_token')
      export SONAR_TOKEN
      echo "SonarQube token retrieved"
  script:
    - echo "Running SonarQube analysis..."
    - |
      mvn ${MAVEN_CLI_OPTS} sonar:sonar \
        -Dsonar.host.url=${SONAR_HOST_URL} \
        -Dsonar.token=${SONAR_TOKEN} \
        -Dsonar.projectKey=${CI_PROJECT_PATH_SLUG} \
        -Dsonar.projectName="${CI_PROJECT_NAME}" \
        -Dsonar.projectVersion=${CI_COMMIT_SHORT_SHA} \
        -Dsonar.sources=src/main/java \
        -Dsonar.tests=src/test/java \
        -Dsonar.java.binaries=target/classes \
        -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    - echo "SonarQube analysis completed"
    - echo "View results: ${SONAR_HOST_URL}/dashboard?id=${CI_PROJECT_PATH_SLUG}"
  needs:
    - build
    - test:unit
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

quality-gate:
  stage: code-quality
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
    - |
      VAULT_TOKEN=$(curl -sk --request POST \
        --data "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}" \
        ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')
    - |
      SONAR_TOKEN=$(curl -sk --header "X-Vault-Token: ${VAULT_TOKEN}" \
        ${VAULT_ADDR}/v1/secret/data/cicd/sonarqube | jq -r '.data.data.ci_token')
      export SONAR_TOKEN
  script:
    - echo "Checking Quality Gate..."
    - sleep 15
    - |
      STATUS=$(curl -sk -u "${SONAR_TOKEN}:" \
        "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${CI_PROJECT_PATH_SLUG}" \
        | jq -r '.projectStatus.status')
      echo "Quality Gate: ${STATUS}"
      if [ "${STATUS}" != "OK" ] && [ "${STATUS}" != "WARN" ]; then
        echo "Quality Gate FAILED!"
        exit 1
      fi
      echo "Quality Gate PASSED!"
  needs:
    - sonarqube-scan
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# =============================================================================
# PACKAGE STAGE
# =============================================================================

package:
  stage: package
  image: maven:3.9-eclipse-temurin-${JAVA_VERSION}
  script:
    - echo "Packaging Spring Boot application..."
    - mvn ${MAVEN_CLI_OPTS} package -DskipTests
    - echo "Application packaged"
    - ls -lh target/*.jar 2>/dev/null || ls -lh target/*.war 2>/dev/null || true
  artifacts:
    paths:
      - target/*.jar
      - target/*.war
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'

build-image:
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    IMAGE_TAG: "${REGISTRY_HOST}/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
    IMAGE_LATEST: "${REGISTRY_HOST}/${CI_PROJECT_PATH}:latest"
  script:
    - echo "Building Docker image with Kaniko"
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${REGISTRY_HOST}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${IMAGE_TAG}" \
        --destination "${IMAGE_LATEST}" \
        --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        --build-arg VCS_REF=${CI_COMMIT_SHORT_SHA} \
        --insecure \
        --skip-tls-verify \
        --cache=true \
        --cache-ttl=24h
    - echo "Image: ${IMAGE_TAG}"
  needs:
    - package
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'

# =============================================================================
# DEPLOY STAGE
# =============================================================================

deploy:dev:
  stage: deploy
  image: alpine/git:latest
  variables:
    ENVIRONMENT: "development"
    MANIFEST_REPO_URL: "http://gitlab-webservice-default.gitlab-system.svc.cluster.local:8181/daitics-com/k8s-manifests.git"
  before_script:
    - apk add --no-cache curl jq
    - |
      VAULT_TOKEN=$(curl -sk --request POST \
        --data "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}" \
        ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')
    - |
      GITLAB_DEPLOY_TOKEN=$(curl -sk --header "X-Vault-Token: ${VAULT_TOKEN}" \
        ${VAULT_ADDR}/v1/secret/data/cicd/gitlab | jq -r '.data.data.deploy_token')
      export GITLAB_DEPLOY_TOKEN
  script:
    - echo "Deploying to ${ENVIRONMENT}..."
    - |
      REPO_URL_WITH_AUTH=$(echo "${MANIFEST_REPO_URL}" | sed "s|http://|http://deploy:${GITLAB_DEPLOY_TOKEN}@|")
      git clone "${REPO_URL_WITH_AUTH}" k8s-manifests
      cd k8s-manifests
    - git config user.email "gitlab-ci@daitics.local"
    - git config user.name "GitLab CI"
    - |
      MANIFEST_PATH="environments/${ENVIRONMENT}/${CI_PROJECT_NAME}/deployment.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        NEW_IMAGE="${REGISTRY_HOST}/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
        sed -i "s|image:.*|image: ${NEW_IMAGE}|g" "${MANIFEST_PATH}"
        git add . && git commit -m "Deploy ${CI_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA} to ${ENVIRONMENT}" && git push
        echo "Deployment updated - ArgoCD will sync"
      else
        echo "Manifest not found at ${MANIFEST_PATH}"
      fi
  environment:
    name: development
    url: https://dev-${CI_PROJECT_NAME}.service.daitics.local
  needs:
    - build-image
    - quality-gate
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success  # Automatic - no approval

deploy:prod:
  stage: deploy
  image: alpine/git:latest
  variables:
    ENVIRONMENT: "production"
    MANIFEST_REPO_URL: "http://gitlab-webservice-default.gitlab-system.svc.cluster.local:8181/daitics-com/k8s-manifests.git"
  before_script:
    - apk add --no-cache curl jq
    - |
      VAULT_TOKEN=$(curl -sk --request POST \
        --data "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}" \
        ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')
    - |
      GITLAB_DEPLOY_TOKEN=$(curl -sk --header "X-Vault-Token: ${VAULT_TOKEN}" \
        ${VAULT_ADDR}/v1/secret/data/cicd/gitlab | jq -r '.data.data.deploy_token')
      export GITLAB_DEPLOY_TOKEN
  script:
    - echo "Deploying to ${ENVIRONMENT}..."
    - |
      REPO_URL_WITH_AUTH=$(echo "${MANIFEST_REPO_URL}" | sed "s|http://|http://deploy:${GITLAB_DEPLOY_TOKEN}@|")
      git clone "${REPO_URL_WITH_AUTH}" k8s-manifests
      cd k8s-manifests
    - git config user.email "gitlab-ci@daitics.local"
    - git config user.name "GitLab CI"
    - |
      MANIFEST_PATH="environments/${ENVIRONMENT}/${CI_PROJECT_NAME}/deployment.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        NEW_IMAGE="${REGISTRY_HOST}/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
        sed -i "s|image:.*|image: ${NEW_IMAGE}|g" "${MANIFEST_PATH}"
        git add . && git commit -m "Deploy ${CI_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA} to ${ENVIRONMENT}" && git push
        echo "Deployment updated - ArgoCD will sync"
      else
        echo "Manifest not found at ${MANIFEST_PATH}"
      fi
  environment:
    name: production
    url: https://${CI_PROJECT_NAME}.service.daitics.local
  needs:
    - build-image
    - quality-gate
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual  # Requires approval